# Dataset Pipeline - Docker Compose
# LLM-as-a-Judge 기반 QA 데이터셋 생성 파이프라인
#
# Usage:
#   docker-compose build                              # 이미지 빌드
#   docker-compose --profile config run config        # 설정 확인
#   docker-compose --profile crawl run crawler        # 웹 크롤링
#   docker-compose --profile translate run translator # 번역
#   docker-compose --profile qa run qa-generator      # QA 생성
#   docker-compose --profile validate run validator   # 검증
#   docker-compose --profile test run test            # 테스트
#   docker-compose --profile shell run shell          # 대화형 셸
#
# Environment Variables (.env 또는 export):
#   API_KEY         - LLM API 키 (필수)
#   OPENAI_BASE_URL - API 엔드포인트 (선택)

services:
  # ============================================
  # 설정 확인
  # ============================================
  config:
    build: .
    image: dataset-pipeline:latest
    environment:
      - API_KEY=${API_KEY:-}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-}
    volumes:
      - ./config:/app/config:ro
      - ./output:/app/output
    command: ["config", "--show-all"]
    profiles: ["config"]

  # ============================================
  # 웹 크롤링 (와사비)
  # ============================================
  crawler:
    build: .
    image: dataset-pipeline:latest
    volumes:
      - ./output:/app/output
    command: [
      "crawl-wasabi",
      "--output", "/app/output/wasabi_web_en.jsonl",
      "--limit", "100"
    ]
    profiles: ["crawl"]

  # ============================================
  # EN→KO 번역
  # ============================================
  translator:
    build: .
    image: dataset-pipeline:latest
    environment:
      - API_KEY=${API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-}
    volumes:
      - ./output:/app/output
    command: [
      "translate",
      "--input", "/app/output/wasabi_web_en.jsonl",
      "--output", "/app/output/wasabi_en_ko.jsonl",
      "--resume"
    ]
    profiles: ["translate"]

  # ============================================
  # QA 데이터셋 생성
  # ============================================
  qa-generator:
    build: .
    image: dataset-pipeline:latest
    environment:
      - API_KEY=${API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-}
    volumes:
      - ./output:/app/output
      - ./prompts:/app/prompts:ro
    command: [
      "generate-qa",
      "--input", "/app/output/wasabi_en_ko.jsonl",
      "--output", "/app/output/wasabi_qa_dataset.jsonl",
      "--num-questions", "220",
      "--resume"
    ]
    profiles: ["qa"]

  # ============================================
  # 데이터셋 검증
  # ============================================
  validator:
    build: .
    image: dataset-pipeline:latest
    volumes:
      - ./output:/app/output
    entrypoint: ["python"]
    command: [
      "-c",
      "import json; from dataset_pipeline.validation import DatasetValidator; qa_pairs = [json.loads(line) for line in open('/app/output/wasabi_qa_dataset.jsonl', encoding='utf-8')]; validator = DatasetValidator(); report = validator.validate(qa_pairs, 'wasabi_qa'); print(report.summary()); report.save('/app/output/validation_report')"
    ]
    profiles: ["validate"]

  # ============================================
  # 테스트 실행
  # ============================================
  test:
    build: .
    image: dataset-pipeline:latest
    volumes:
      - ./tests:/app/tests:ro
      - ./src:/app/src:ro
    entrypoint: ["pytest"]
    command: ["/app/tests", "-v", "--tb=short"]
    profiles: ["test"]

  # ============================================
  # 대화형 셸
  # ============================================
  shell:
    build: .
    image: dataset-pipeline:latest
    environment:
      - API_KEY=${API_KEY:-}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-}
    volumes:
      - ./config:/app/config
      - ./output:/app/output
      - ./src:/app/src
      - ./prompts:/app/prompts
      - ./tests:/app/tests
    entrypoint: ["/bin/bash"]
    stdin_open: true
    tty: true
    profiles: ["shell"]

  # ============================================
  # MQM 번역 품질 평가
  # ============================================
  mqm-scorer:
    build: .
    image: dataset-pipeline:latest
    environment:
      - API_KEY=${API_KEY}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-}
    volumes:
      - ./output:/app/output
    command: [
      "mqm-score",
      "--input", "/app/output/wasabi_en_ko.jsonl",
      "--output", "/app/output/wasabi_scored.jsonl"
    ]
    profiles: ["mqm"]

  # ============================================
  # CGIAR 데이터셋 추출
  # ============================================
  cgiar-exporter:
    build: .
    image: dataset-pipeline:latest
    environment:
      - HF_TOKEN=${HF_TOKEN:-}
    volumes:
      - ./output:/app/output
    command: [
      "export-cgiar",
      "--output", "/app/output/cgiar_en.jsonl",
      "--limit-per-dataset", "200"
    ]
    profiles: ["cgiar"]
